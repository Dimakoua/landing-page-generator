name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Lint code
      run: npm run lint

    - name: Run tests
      run: npm run test:run

    - name: Build project
      run: npm run build

    - name: Check bundle size
      run: |
        # Find the main index bundle file
        INDEX_FILE=$(ls dist/assets/index-*.js | head -1)
        
        if [ -z "$INDEX_FILE" ]; then
          echo "âŒ Could not find index bundle file"
          exit 1
        fi
        
        # Get uncompressed size (KB)
        BUNDLE_SIZE=$(ls -la "$INDEX_FILE" | awk '{printf "%.2f", $5/1024}')
        echo "ðŸ“¦ Main bundle size: ${BUNDLE_SIZE} kB (uncompressed)"
        
        # Calculate gzipped size (KB)
        GZIPPED_SIZE=$(gzip -c "$INDEX_FILE" | wc -c | awk '{printf "%.2f", $1/1024}')
        echo "ðŸ“¦ Gzipped bundle size: ${GZIPPED_SIZE} kB"
        
        # Thresholds (gzipped, in kB)
        RECOMMENDED_GZIP_KB=150   # realistic target for initial/main bundle
        HARD_LIMIT_GZIP_KB=250    # fail CI if exceeded
        
        echo "â„¹ï¸ Recommended (warning) limit: ${RECOMMENDED_GZIP_KB} kB gzipped"
        echo "â„¹ï¸ Hard (fail) limit: ${HARD_LIMIT_GZIP_KB} kB gzipped"
        
        # Emit warning if above recommended target
        if (( $(echo "$GZIPPED_SIZE > $RECOMMENDED_GZIP_KB" | bc -l) )); then
          echo "âš ï¸ Warning: Bundle size exceeds recommended ${RECOMMENDED_GZIP_KB} kB gzipped: ${GZIPPED_SIZE} kB"
        else
          echo "âœ… Bundle size within recommended target: ${GZIPPED_SIZE} kB"
        fi
        
        # Do NOT fail CI for large bundles â€” emit a warning instead and recommend fixes
        if (( $(echo "$GZIPPED_SIZE > $HARD_LIMIT_GZIP_KB" | bc -l) )); then
          echo "::warning title=Bundle size exceeded::Bundle size exceeded hard limit (${HARD_LIMIT_GZIP_KB} kB gzipped): ${GZIPPED_SIZE} kB"
          echo "ðŸ”§ Recommend running a bundle analyzer (source-map-explorer / vite-plugin-visualizer) to identify and optimize large modules or lazy-load optional features."
        fi
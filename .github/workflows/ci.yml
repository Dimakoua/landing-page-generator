name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Lint code
      run: npm run lint

    - name: Run tests
      run: npm run test:run

    - name: Build project
      run: npm run build

    - name: Check bundle size
      run: |
        # Find the main index bundle file
        INDEX_FILE=$(ls dist/assets/index-*.js | head -1)
        
        if [ -z "$INDEX_FILE" ]; then
          echo "‚ùå Could not find index bundle file"
          exit 1
        fi
        
        # Get uncompressed size
        BUNDLE_SIZE=$(ls -la "$INDEX_FILE" | awk '{print $5/1024}')
        echo "üì¶ Main bundle size: ${BUNDLE_SIZE} kB (uncompressed)"
        
        # Calculate gzipped size
        GZIPPED_SIZE=$(gzip -c "$INDEX_FILE" | wc -c | awk '{print $1/1024}')
        echo "üì¶ Gzipped bundle size: ${GZIPPED_SIZE} kB"
        
        # Check if bundle exceeds recommended limit (75 kB gzipped)
        if (( $(echo "$GZIPPED_SIZE > 75" | bc -l) )); then
          echo "‚ö†Ô∏è Warning: Bundle size exceeds 75 kB gzipped target: ${GZIPPED_SIZE} kB"
          echo "Consider optimizing bundle size for better performance"
        else
          echo "‚úÖ Bundle size within recommended limit: ${GZIPPED_SIZE} kB"
        fi